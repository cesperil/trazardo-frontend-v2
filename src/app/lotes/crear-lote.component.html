<div class="container mt-5">
  <div class="card shadow">
    <div class="card-header">
      <h3>Crear Lote <span *ngIf="fincaNombre">para la Finca {{ fincaNombre }}</span></h3>
    </div>
    <div class="card-body">
      <form (ngSubmit)="saveLote()">
        <!-- Lote ID -->
        <div class="row mb-4">
          <div class="col-md-12">
            <label for="loteId" class="form-label">Identificador del Lote</label>
            <input type="text" id="loteId" class="form-control" [(ngModel)]="loteId" name="loteId" required />
          </div>
        </div>

        <div class="row mb-4" *ngIf="isAdmin">
          <div class="col-md-6">
            <label for="tecnico" class="form-label">Técnico</label>
            <app-searchable-dropdown [(ngModel)]="selectedTecnicoId" [options]="tecnicos" optionLabel="nombreCompleto"
              optionValue="id" placeholder="Seleccione un técnico" (selectionChange)="onSelectionChange()"
              inputId="tecnico">
            </app-searchable-dropdown>
          </div>
          <div class="col-md-6">
            <label for="explotacion" class="form-label">Explotación (Finca)</label>
            <app-searchable-dropdown [(ngModel)]="selectedFincaId" [options]="explotaciones" optionLabel="nombre"
              optionValue="id" placeholder="Seleccione una finca" (selectionChange)="onSelectionChange()"
              inputId="explotacion">
            </app-searchable-dropdown>
          </div>
        </div>

        <!-- Series Crotales -->
        <div class="row mb-4">
          <div class="col-md-12">
            <label class="form-label d-flex justify-content-between align-items-center">
              Series de Crotales
              <button type="button" class="btn btn-sm btn-outline-primary"
                (click)="seriesCrotales.push({crotalDesde: '', crotalHasta: ''})">
                + Añadir Serie
              </button>
            </label>
            <div class="card mb-2" *ngFor="let serie of seriesCrotales; let i = index">
              <div class="card-body p-2 d-flex align-items-center gap-2">
                <div class="flex-grow-1">
                  <label [for]="'crotalDesde' + i" class="form-label mb-0 small">Crotal desde</label>
                  <input type="text" [id]="'crotalDesde' + i" class="form-control form-control-sm"
                    [(ngModel)]="serie.crotalDesde" [name]="'crotalDesde' + i" required />
                </div>
                <div class="flex-grow-1">
                  <label [for]="'crotalHasta' + i" class="form-label mb-0 small">Crotal hasta</label>
                  <input type="text" [id]="'crotalHasta' + i" class="form-control form-control-sm"
                    [(ngModel)]="serie.crotalHasta" [name]="'crotalHasta' + i" required />
                </div>
                <button *ngIf="seriesCrotales.length > 1" type="button" class="btn btn-sm btn-outline-danger mt-4"
                  (click)="seriesCrotales.splice(i, 1)" title="Eliminar Serie">
                  <i class="bi bi-trash"></i> Eliminar
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Localización Crotal & Raza -->
        <div class="row mb-4">
          <div class="col-md-6">
            <label for="localizacionCrotal" class="form-label">Localización Crotal</label>
            <select id="localizacionCrotal" class="form-control" [(ngModel)]="localizacionCrotal"
              name="localizacionCrotal" required>
              <option value="OREJAIZQ">Oreja izquierda</option>
              <option value="OREJADER">Oreja derecha</option>
              <option value="NO_DETERMINADA">No se indica</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="raza" class="form-label">Raza</label>
            <select id="raza" class="form-control" [(ngModel)]="raza" name="raza" required>
              <option value="IBERICA100">100% Ibérico</option>
              <option value="IBERICA75">75% Ibérico</option>
              <option value="NO_DETERMINADA">No se indica</option>
            </select>
          </div>
        </div>

        <!-- Ganadero & Fecha Nacimiento -->
        <div class="row mb-4">
          <div class="col-md-6">
            <label for="ganadero" class="form-label">Ganadero</label>
            <app-searchable-dropdown [(ngModel)]="ganaderoId" [options]="ganaderos" optionLabel="nombreCompleto"
              optionValue="id" placeholder="Seleccione un ganadero" inputId="ganadero">
            </app-searchable-dropdown>
          </div>
          <div class="col-md-6">
            <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento</label>
            <input type="date" id="fechaNacimiento" class="form-control" [(ngModel)]="fechaNacimiento"
              name="fechaNacimiento" />
          </div>
        </div>

        <!-- Buttons -->
        <div class="row">
          <div class="col-md-12 d-flex">
            <button type="submit" class="btn btn-success">Guardar</button>
            <button type="button" class="btn btn-secondary ms-2" (click)="cancel()">
              Cancelar
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>